<!DOCTYPE html>
<meta charset="utf-8">
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<head>
<style>
/* css goes here */
body, html {
  font-family: Helvetica, sans-serif;
  text-align: left;
}

.wrap {
    margin: 10px;
    display: inline-block;
}

#sections {
position: relative;
display: inline-block;
width: 250px;
top: 0px;
z-index: 90;
}

.step {
    margin-bottom: 200px;
}

#viz{
    display: inline-block;
    position: fixed;
    top: 60px;
    right: 10px;
    z-index: 1;
    margin-left: 0;

    height: 600px;
    width: 600px;
}
#slider {
  position: fixed;
  display: inline-block;
  top: 600px;
  width:400px;
  right: 160px;
  z-index: 1;
}

#sliderbox {
  position: fixed;
  display: inline-block;
  top: 580px;
  width:400px;
  right: 160px;
  z-index: 1;
  }

.viz1 {
    opacity: 1
}
.viz2 {
    opacity: 0
}
.viz3 {
    opacity: 0
}
.viz4 {
    opacity: 0
}
.title {
  font-family: Helvetica, sans-serif;
  text-align: left;
  font-weight: bold;
}
</style>
</head>
<div class="wrap">
    <div id="sections">
         <section class="step">
            <div class="title">The April 2020 bluebike collapse</div>
         In March 2020, the novel coronavirus switched from being a distant concern to an immediate and pressing danger in the United States.
         The first week or two, people mostly operated as normal, taking more care to wash hands and avoid touching their face. For the 
         aggregated ridership data, the real turning point was in April 2020, when the majority of the population stayed locked at home while
         businesses shuttered and the case rate soared. The total number of Bluebikes trips fell well below its April 2019 levels and even below
         the typical winter troughs, recovering that summer as biking became one of the safest forms of travel, but still not quite
         reaching its 2019 highs. Whatever advantages Bluebikes had over competing modes of transportation in safety, it still lost riders
         as people had fewer reasons to leave home. 
         </section>

         <section class="step">
            <div class="title">Median ride duration skyrocketed</div>
            As the raw number of bike rides fell in April 2020, the median duration of a bike ride doubled from 10 minutes to 20. In the months
            since, the median bike ride has shortened to a level near its historical average. While it's difficult to say exactly why people
            started taking longer bike rides during the pandemic, we can speculate. The shorter bike rides to and from campus that
            formed studenet commutes likely disappeared as students went home. Perceived danger of public transportation and ridesharing services
            could have contributed to people choosing to use Bluebikes for longer trips in the summer days. Finally, with many traditional
            leisure activities closed, some could have used Bluebikes to go on long joyrides in the summer sun.
         </section>

         <section class="step">
            <div class="title">The missing morning commute</div>
            Bluebikes's aggregated trips per hour told a predictable story: bike use peaked during 8 AM and 5 PM as people commuted
            to and from college/work, with a lot more overall rides in the warmer months. In the first few months post-pandemic, 
            the 8 AM peak disappeared entirely, and it still hasn't recovered to anywhere near its old values. Instead we see
            a distribution centered around 5-6 PM travel, perhaps due to some commuting and to some work-from-homers finishing up their
            day and running errands.
         </section>

         <section class="step">
          <div class="title">Who was hit the hardest? </div>
            The loss of the undergraduate student body hit MIT's Bluebikes stations hard, with the September 2020 ridership less than 
            half that of the September 2019 at the Mass Ave stop. This pattern repeated city-wide, with traditional poles of 
            Bluebikes travel losing disproportionately more riders with the schools and offices that drew people to them shuttered. 
         </section>
         <section class="step">
          <div class="title">Part 5 text here:</div>
            Neque gravida in fermentum et sollicitudin ac. Imperdiet massa tincidunt nunc pulvinar sapien et ligula ullamcorper malesuada. Nisl pretium fusce id velit. Dignissim diam quis enim lobortis scelerisque fermentum dui. Elit ut aliquam purus sit amet. Lacus vel facilisis volutpat est. Dui sapien eget mi proin sed libero enim sed. Non nisi est sit amet facilisis. Libero nunc consequat interdum varius sit amet mattis vulputate.
         </section>
    </div>
    <div id="viz" ></div>
    <span class="viz3" id="sliderbox">Slide for month</span>
    <input class="viz3" type="range" name="slider" id="slider" min="0" max="24" value="18">
</div>
<script>

let years  = [2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019, 2019, 
              2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020, 2020,
              2021, 2021, 2021]
let months = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11,
              0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,
              0, 1, 2]


// Scrollytelling source: https://towardsdatascience.com/how-i-created-an-interactive-scrolling-visualisation-with-d3-js-and-how-you-can-too-e116372e2c73

// Handle scroll events
function scroller(){
  let container = d3.select('body')
  let dispatch = d3.dispatch('active', 'progress');
  let sections = d3.selectAll('.step')
  let sectionPositions
  let currentIndex = -1
  let containerStart = 0;

  // Binds functions to their events
  function scroll(){
    d3.select(window)
      .on('scroll.scroller', position)
      .on('resize.scroller', resize)
      resize();
    let timer = d3.timer(function() {
      position();
      timer.stop();
    });
  }

  // Deal with window resizing
  function resize(){
    sectionPositions = [];
    let startPos;
    sections.each(function(d, i) {
      let top = this.getBoundingClientRect().top;
      if (i === 0 ){
        startPos = top;
      }
      sectionPositions.push(top - startPos)
    });
  }

  // Where the user is on the page
  function position() {
    let pos = window.pageYOffset - 300 - containerStart;
    let sectionIndex = d3.bisect(sectionPositions, pos);
    sectionIndex = Math.min(sections.size()-1, sectionIndex);
    if (currentIndex !== sectionIndex){
      dispatch.call('active', this, sectionIndex);
      currentIndex = sectionIndex;
    }
    let prevIndex = Math.max(sectionIndex - 1, 0);
    let prevTop = sectionPositions[prevIndex]
    let progress = (pos - prevTop) / (sectionPositions[sectionIndex]   - prevTop);
    dispatch.call('progress', this, currentIndex, progress)
  }

  scroll.container = function(value) {
    if (arguments.length === 0){
      return container
    }
    container = value
    return scroll
  }
  scroll.on = function(action, callback){
    dispatch.on(action, callback)
  };
  return scroll;
}

let scroll = scroller().container(d3.select('.wrap'))

scroll()

const durationTime = 200

function draw1 () {
    d3.selectAll(".viz1").transition().duration(durationTime).style("opacity", "1.0")
    d3.selectAll(".viz2").transition().duration(durationTime).style("opacity", "0")
    d3.selectAll(".viz3").transition().duration(durationTime).style("opacity", "0")
}

function draw2 () {
    d3.selectAll(".viz1").transition().duration(durationTime).style("opacity", "0")
    d3.selectAll(".viz2").transition().duration(durationTime).style("opacity", "1")
    d3.selectAll(".viz3").transition().duration(durationTime).style("opacity", "0")
}

function draw3 () {
    d3.selectAll(".viz2").transition().duration(durationTime).style("opacity", "0")
    d3.selectAll(".viz3").transition().duration(durationTime).style("opacity", "1.0")
    d3.selectAll(".viz4").transition().duration(durationTime).style("opacity", "0")
}

function draw4 () {
    d3.selectAll(".viz3").transition().duration(durationTime).style("opacity", "0")
    d3.selectAll(".viz4").transition().duration(durationTime).style("opacity", "1.0")
}
// Each of these is a function to draw each step of the scrollytelling
let activationFunctions = [
  draw1,
  draw2,
  draw3,
  draw4
]

let lastIndex, activeIndex = 0
scroll.on('active', function(index){
  d3.selectAll('.step')
    .transition().duration(500)
    .style('opacity', function (d, i) {return i === index ? 1 : 0.1;});
    activeIndex = index
  let sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
  let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);
  scrolledSections.forEach(i => {
    activationFunctions[i]();
  })
  lastIndex = activeIndex;
})


var viz = d3.select("#viz")
    .append("svg")
        .attr("width", 600)
        .attr("height", 600)
    .append("g")
        .attr("transform",
              "translate(" + 50 + "," + 50 + ")");


d3.queue()
  .defer(d3.csv, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/trips-per-month.csv")
  .defer(d3.csv, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/tripduration-by-week.csv")
  .defer(d3.json, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/Boston_Neighborhoods.geojson")
  .defer(d3.csv, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/tripsperhour.csv")
  .defer(d3.csv, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/201903-bluebikes-tripdata.csv")
  .await(ready);

function ready(error, tripspermonth, tripdur, boston, tripsperhour, ...alldata) {
    console.log("Loaded " + alldata.length + " raw data files")
    //data = d3.merge(alldata)

    // Building visualization 1:
    // Add x axis
    var scaleX_tpm = d3.scaleTime()
      .domain(d3.extent(tripspermonth, 
          function(d) { 
              return d3.timeParse("%b-%y")(d["Month of Starttime"]); 
          }))
      .range([ 0, 400]);
    viz.append("g")
      .attr("class", "viz1")
      .attr("transform", "translate(0," + 400 + ")")
      .call(d3.axisBottom(scaleX_tpm));

    // Add Y axis
    var scaleY_tpm = d3.scaleLinear()
      .domain([0, d3.max(tripspermonth, function(d) {return +d["NumTrips"]; })])
      .range([ 400, 0 ]);
    viz.append("g")
      .attr("class", "viz1")
      .call(d3.axisLeft(scaleY_tpm));
            
    // Add the line
    viz.append("path")
      .attr("class", "viz1")
      .datum(tripspermonth)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) { 
            return scaleX_tpm(d3.timeParse("%b-%y")(d["Month of Starttime"]));
          })
        .y(function(d) { return scaleY_tpm(+d["NumTrips"]); })
        )
        
    // Building viz 2
    var scaleX_td = d3.scaleTime()
      .domain(d3.extent(tripdur,
        function(d) {
          return d3.timeParse("%d-%b-%y")(d["Week of Starttime"]);
        }))
        .range([0, 400]);
    viz.append("g")
      .attr("class", "viz2")
      .attr("transform", "translate(0," + 400 + ")")
      .call(d3.axisBottom(scaleX_td));
     
    var scaleY_td = d3.scaleLinear()
      .domain([0, d3.max(tripdur, function(d) {return +d["Median Tripduration"]; })])
      .range([ 400, 0 ]);
    viz.append("g")
      .attr("class", "viz2")
      .call(d3.axisLeft(scaleY_td));

    viz.append("path")
      .attr("class", "viz2")
      .datum(tripdur)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) {
          return scaleX_td(d3.timeParse("%d-%b-%y")(d["Week of Starttime"]));
        })
        //.y(function(d) {return 0;})
        .y(function(d) { return scaleY_td(+d["Median Tripduration"]); })
        )
        
    // Building viz 3
    const tph_timeparse = "%b-%y"
        
    var tph_year = 2020
    var tph_month = 8
    var filtered_tph = tripsperhour.filter(function(d) {
      // console.log(d);
      d_time = d3.timeParse(tph_timeparse)(d["Month of Starttime"]);
      // console.log(d_time)
      return d_time.getMonth() == tph_month && d_time.getFullYear() == tph_year;
    })

    var scaleX_tph = d3.scaleBand()
      .domain(d3.range(24))
      .range([0, 400])
      .padding(0.1);
    viz.append("g")
      .attr("class", "viz3")
      .attr("transform", "translate(0," + 400 + ")")
      .call(d3.axisBottom(scaleX_tph));
        
    var scaleY_tph = d3.scaleLinear()
      .domain([0, d3.max(tripsperhour, function(d) {return +d["NumTrips"]; })])
      .range([ 400, 0 ]);
    viz.append("g")
      .attr("class", "viz3")
      .call(d3.axisLeft(scaleY_tph));
          
    d3.select("#viz svg").append("g")
      .attr("class", "viz3")
      .attr("id", "viz3bars")
      .attr("transform",
              "translate(" + 50 + "," + 50 + ")")
      .selectAll("rect")
      .data(filtered_tph)
      .enter().append("rect")
        .attr("x", function(d) { 
          return scaleX_tph(+d["Hour of Starttime"]);
        })
        .attr("y", d => scaleY_tph(+d["NumTrips"]))
        .attr("height", d => scaleY_tph(0)-scaleY_tph(+d["NumTrips"]))
        .attr("width", scaleX_tph.bandwidth())
        .attr("fill", "steelblue")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1.5);

    // Building visualization 4:
    var projection = d3.geoMercator()
      .scale(100000)
      .center([-71.057, 42.313])
      .translate([600/2, 600/2]);

    // A path generator
    var path = d3.geoPath()
        .projection(projection)

    var vizsvg = d3.select("#viz svg");
    vizsvg.append("g")
      .attr("class", "viz4")
      .selectAll("path")
      .data(boston.features)
      .enter().append("path")
          .attr("fill", "#b8b8b8")
          .attr("d", d3.geoPath()
              .projection(projection)
          )
          .style("stroke", "#000")
          .style("stroke-width", 0)

    function updateSlider(v) {
      var tph_year = years[v]
      var tph_month = months[v]
      d3.select("#sliderbox").text(tph_month + "/" + tph_year)
      console.log("slider " + v + ": " + tph_year + " " + tph_month)
      var filtered_tph = tripsperhour.filter(function(d) {
        d_time = d3.timeParse(tph_timeparse)(d["Month of Starttime"]);
        return d_time.getMonth() == tph_month && d_time.getFullYear() == tph_year;
      })
      var sel = d3.select("#viz3bars")
        .selectAll("rect")
        .data(tripsperhour).remove()
      var sel = d3.select("#viz3bars")
        .selectAll("rect")
        .data(filtered_tph)
      sel.exit().remove()
      sel.enter().append("rect")
        .attr("x", function(d) { 
          return scaleX_tph(+d["Hour of Starttime"]);
        })
        .attr("y", d => scaleY_tph(+d["NumTrips"]))
        .attr("height", d => scaleY_tph(0)-scaleY_tph(+d["NumTrips"]))
        .attr("width", scaleX_tph.bandwidth())
        .attr("fill", "steelblue")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1.5);
      
    }

    d3.select("#slider").on("input", function(){
      updateSlider(+this.value)
    })

}
</script>