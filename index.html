<!DOCTYPE html>
<meta charset="utf-8">
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

<head>
<style>
/* css goes here */
body, html {
  font-family: Helvetica, sans-serif;
  text-align: left;
}

.wrap {
    margin: 10px;
    display: inline-block;
}

#sections {
position: relative;
display: inline-block;
width: 250px;
top: 0px;
z-index: 90;
}

.step {
    margin-bottom: 200px;
}

#viz{
    display: inline-block;
    position: fixed;
    top: 60px;
    z-index: 1;
    margin-left: 0;

    height: 600px;
    width: 600px;
}

.viz1 {
    opacity: 1
}
.viz2 {
    opacity: 0
}
.viz3 {
    opacity: 0
}
.viz4 {
    opacity: 0
}
</style>
</head>
<div class="wrap">
    <div id="sections">
         <section class="step">
            <div class="title">Part 1 text here:</div>
         Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
         </section>

         <section class="step">
            <div class="title">Part 2 text here:</div>
            Euismod in pellentesque massa placerat duis. Sagittis vitae et leo duis ut diam. Sit amet luctus venenatis lectus magna fringilla urna porttitor. Pellentesque elit eget gravida cum. Ac tortor dignissim convallis aenean. Dui ut ornare lectus sit amet. Adipiscing diam donec adipiscing tristique risus nec feugiat in fermentum. Cursus euismod quis viverra nibh. Nisl nisi scelerisque eu ultrices vitae auctor. Purus semper eget duis at tellus at urna condimentum. Integer malesuada nunc vel risus.
         </section>

         <section class="step">
            <div class="title">Part 3 text here:</div>
            Neque gravida in fermentum et sollicitudin ac. Imperdiet massa tincidunt nunc pulvinar sapien et ligula ullamcorper malesuada. Nisl pretium fusce id velit. Dignissim diam quis enim lobortis scelerisque fermentum dui. Elit ut aliquam purus sit amet. Lacus vel facilisis volutpat est. Dui sapien eget mi proin sed libero enim sed. Non nisi est sit amet facilisis. Libero nunc consequat interdum varius sit amet mattis vulputate.
         </section>

         <section class="step">
          <div class="title">Part 4 text here:</div>
            Neque gravida in fermentum et sollicitudin ac. Imperdiet massa tincidunt nunc pulvinar sapien et ligula ullamcorper malesuada. Nisl pretium fusce id velit. Dignissim diam quis enim lobortis scelerisque fermentum dui. Elit ut aliquam purus sit amet. Lacus vel facilisis volutpat est. Dui sapien eget mi proin sed libero enim sed. Non nisi est sit amet facilisis. Libero nunc consequat interdum varius sit amet mattis vulputate.
         </section>
         <section class="step">
          <div class="title">Part 5 text here:</div>
            Neque gravida in fermentum et sollicitudin ac. Imperdiet massa tincidunt nunc pulvinar sapien et ligula ullamcorper malesuada. Nisl pretium fusce id velit. Dignissim diam quis enim lobortis scelerisque fermentum dui. Elit ut aliquam purus sit amet. Lacus vel facilisis volutpat est. Dui sapien eget mi proin sed libero enim sed. Non nisi est sit amet facilisis. Libero nunc consequat interdum varius sit amet mattis vulputate.
         </section>
    </div>
    <div id="viz" ></div>
</div>
<script>

// Scrollytelling source: https://towardsdatascience.com/how-i-created-an-interactive-scrolling-visualisation-with-d3-js-and-how-you-can-too-e116372e2c73

// Handle scroll events
function scroller(){
  let container = d3.select('body')
  let dispatch = d3.dispatch('active', 'progress');
  let sections = d3.selectAll('.step')
  let sectionPositions
  let currentIndex = -1
  let containerStart = 0;

  // Binds functions to their events
  function scroll(){
    d3.select(window)
      .on('scroll.scroller', position)
      .on('resize.scroller', resize)
      resize();
    let timer = d3.timer(function() {
      position();
      timer.stop();
    });
  }

  // Deal with window resizing
  function resize(){
    sectionPositions = [];
    let startPos;
    sections.each(function(d, i) {
      let top = this.getBoundingClientRect().top;
      if (i === 0 ){
        startPos = top;
      }
      sectionPositions.push(top - startPos)
    });
  }

  // Where the user is on the page
  function position() {
    let pos = window.pageYOffset - 300 - containerStart;
    let sectionIndex = d3.bisect(sectionPositions, pos);
    sectionIndex = Math.min(sections.size()-1, sectionIndex);
    if (currentIndex !== sectionIndex){
      dispatch.call('active', this, sectionIndex);
      currentIndex = sectionIndex;
    }
    let prevIndex = Math.max(sectionIndex - 1, 0);
    let prevTop = sectionPositions[prevIndex]
    let progress = (pos - prevTop) / (sectionPositions[sectionIndex]   - prevTop);
    dispatch.call('progress', this, currentIndex, progress)
  }

  scroll.container = function(value) {
    if (arguments.legth === 0){
      return container
    }
    container = value
    return scroll
  }
  scroll.on = function(action, callback){
    dispatch.on(action, callback)
  };
  return scroll;
}

let scroll = scroller().container(d3.select('.wrap'))

scroll()

const durationTime = 200

function draw1 () {
    d3.selectAll(".viz1").transition().duration(durationTime).style("opacity", "1.0")
    d3.selectAll(".viz2").transition().duration(durationTime).style("opacity", "0")
    d3.selectAll(".viz3").transition().duration(durationTime).style("opacity", "0")
}

function draw2 () {
    d3.selectAll(".viz1").transition().duration(durationTime).style("opacity", "0")
    d3.selectAll(".viz2").transition().duration(durationTime).style("opacity", "1")
    d3.selectAll(".viz3").transition().duration(durationTime).style("opacity", "0")
}

function draw3 () {
    d3.selectAll(".viz2").transition().duration(durationTime).style("opacity", "0")
    d3.selectAll(".viz3").transition().duration(durationTime).style("opacity", "1.0")
    d3.selectAll(".viz4").transition().duration(durationTime).style("opacity", "0")
}

function draw4 () {
    d3.selectAll(".viz3").transition().duration(durationTime).style("opacity", "0")
    d3.selectAll(".viz4").transition().duration(durationTime).style("opacity", "1.0")
}
// Each of these is a function to draw each step of the scrollytelling
let activationFunctions = [
  draw1,
  draw2,
  draw3,
  draw4
]

let lastIndex, activeIndex = 0
scroll.on('active', function(index){
  d3.selectAll('.step')
    .transition().duration(500)
    .style('opacity', function (d, i) {return i === index ? 1 : 0.1;});
    activeIndex = index
  let sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
  let scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);
  scrolledSections.forEach(i => {
    activationFunctions[i]();
  })
  lastIndex = activeIndex;
})


var viz = d3.select("#viz")
    .append("svg")
        .attr("width", 600)
        .attr("height", 600)
    .append("g")
        .attr("transform",
              "translate(" + 50 + "," + 50 + ")");


d3.queue()
  .defer(d3.csv, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/trips-per-month.csv")
  .defer(d3.csv, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/tripduration-by-week.csv")
  .defer(d3.json, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/Boston_Neighborhoods.geojson")
  .defer(d3.csv, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/tripsperhour.csv")
  .defer(d3.csv, "https://6859-sp21.github.io/final-project-bluebikes-analysis/data/201903-bluebikes-tripdata.csv")
  .await(ready);

function ready(error, tripspermonth, tripdur, boston, tripsperhour, ...alldata) {
    console.log("Loaded " + alldata.length + " raw data files")
    //data = d3.merge(alldata)

    // Building visualization 1:
    // Add x axis
    var scaleX_tpm = d3.scaleTime()
      .domain(d3.extent(tripspermonth, 
          function(d) { 
              return d3.timeParse("%b-%y")(d["Month of Starttime"]); 
          }))
      .range([ 0, 400]);
    viz.append("g")
      .attr("class", "viz1")
      .attr("transform", "translate(0," + 400 + ")")
      .call(d3.axisBottom(scaleX_tpm));

    // Add Y axis
    var scaleY_tpm = d3.scaleLinear()
      .domain([0, d3.max(tripspermonth, function(d) {return +d["NumTrips"]; })])
      .range([ 400, 0 ]);
    viz.append("g")
      .attr("class", "viz1")
      .call(d3.axisLeft(scaleY_tpm));
            
    // Add the line
    viz.append("path")
      .attr("class", "viz1")
      .datum(tripspermonth)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) { 
            return scaleX_tpm(d3.timeParse("%b-%y")(d["Month of Starttime"]));
          })
        .y(function(d) { return scaleY_tpm(+d["NumTrips"]); })
        )
        
    // Building viz 2
    var scaleX_td = d3.scaleTime()
      .domain(d3.extent(tripdur,
        function(d) {
          return d3.timeParse("%d-%b-%y")(d["Week of Starttime"]);
        }))
        .range([0, 400]);
    viz.append("g")
      .attr("class", "viz2")
      .attr("transform", "translate(0," + 400 + ")")
      .call(d3.axisBottom(scaleX_td));
     
    var scaleY_td = d3.scaleLinear()
      .domain([0, d3.max(tripdur, function(d) {return +d["Median Tripduration"]; })])
      .range([ 400, 0 ]);
    viz.append("g")
      .attr("class", "viz2")
      .call(d3.axisLeft(scaleY_td));

    viz.append("path")
      .attr("class", "viz2")
      .datum(tripdur)
      .attr("fill", "none")
      .attr("stroke", "steelblue")
      .attr("stroke-width", 1.5)
      .attr("d", d3.line()
        .x(function(d) {
          return scaleX_td(d3.timeParse("%d-%b-%y")(d["Week of Starttime"]));
        })
        //.y(function(d) {return 0;})
        .y(function(d) { return scaleY_td(+d["Median Tripduration"]); })
        )
        
    // Building viz 3
    const tph_timeparse = "%b-%y"
        
    var tph_year = 2020
    var tph_month = 8
    var filtered_tph = tripsperhour.filter(function(d) {
      // console.log(d);
      d_time = d3.timeParse(tph_timeparse)(d["Month of Starttime"]);
      // console.log(d_time)
      return d_time.getMonth() == tph_month && d_time.getFullYear() == tph_year;
    })

    var scaleX_tph = d3.scaleBand()
      .domain(d3.range(24))
      .range([0, 400])
      .padding(0.1);
    viz.append("g")
      .attr("class", "viz3")
      .attr("transform", "translate(0," + 400 + ")")
      .call(d3.axisBottom(scaleX_tph));
        
    var scaleY_tph = d3.scaleLinear()
      .domain([0, d3.max(filtered_tph, function(d) {return +d["NumTrips"]; })])
      .range([ 400, 0 ]);
    viz.append("g")
      .attr("class", "viz3")
      .call(d3.axisLeft(scaleY_tph));
          
    d3.select("#viz svg").append("g")
      .attr("class", "viz3")
      .attr("transform",
              "translate(" + 50 + "," + 50 + ")")
      .selectAll("rect")
      .data(filtered_tph)
      .enter().append("rect")
        .attr("x", function(d) { 
          console.log(scaleX_tph(+d["Hour of Starttime"]));
          return scaleX_tph(+d["Hour of Starttime"]);
        })
        .attr("y", d => scaleY_tph(+d["NumTrips"]))
        .attr("height", d => scaleY_tph(0)-scaleY_tph(+d["NumTrips"]))
        .attr("width", scaleX_tph.bandwidth())
        .attr("fill", "steelblue")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1.5);

    // Building visualization 4:
    var projection = d3.geoMercator()
      .scale(100000)
      .center([-71.057, 42.313])
      .translate([600/2, 600/2]);

    // A path generator
    var path = d3.geoPath()
        .projection(projection)

    var vizsvg = d3.select("#viz svg");
    vizsvg.append("g")
      .attr("class", "viz4")
      .selectAll("path")
      .data(boston.features)
      .enter().append("path")
          .attr("fill", "#b8b8b8")
          .attr("d", d3.geoPath()
              .projection(projection)
          )
          .style("stroke", "#000")
          .style("stroke-width", 0)

}
</script>